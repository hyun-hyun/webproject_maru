{{>layouts/header}}

<div class="container">
<h4>Animation</h4>
<br>

{{#article}}
<label class="form-label"><h1> {{title}}</h1></label><br>
<label class="form-label">방영 </label> <b>{{broad_date}}</b><br>
<label class="form-label">제작 </label> <b>{{ani_company}}</b><br>
<label class="form-label">원작 </label> <b>{{author}}</b><br>

<br>
<div class="row g-2">
  <div class="col-md-3" align="center">
  <img src="../../images/pic/anime/{{main_pic}}" class="addImage" alt="작품표지"></img>
  <br>
  </div>
  <div class="col-md-8" align="center">
    <!--tag-->
    <ul>
      {{#tagSelectionCounts}}
          <span class="btn btn-primary btn-round m-1" > {{tagName}}: {{count}} reviews</span>
          <input type="checkbox" id="tag_{{id}}" name="tags" value="{{id}}" style="display:none;">
          <!--m 모든방향 마진 mb-0~5 아래, mt 위 ml, mr 등 있음-->
          <!--<button type="button" onclick="toggleTag({{id}})">Toggle</button>-->
      {{/tagSelectionCounts}}
    </ul>
  </div>
</div>

<label class="form-label">줄거리</label>
<br><br>
{{story}}
<br>
<label class="form-label">등장인물</label>
<br>
<div class="image-container">

  {{#subPic1.realChar}}
  <div class="image-item">
  <img src="../../images/pic/anime/{{subPic1.pic}}" class="addImage_m" alt="등장인물1"></img>
  {{subPic1.realChar}}<br>
  <div class="gray-text">{{subPic1.realVoiceChar}}</div>
  {{subPic1.korChar}}<br>
  <div class="gray-text">{{subPic1.korVoiceChar}}</div>
  </div>
  {{/subPic1.realChar}}

  {{#subPic2.realChar}}
  <div class="image-item">
  <img src="../../images/pic/anime/{{subPic2.pic}}" class="addImage_m" alt="등장인물2"></img>
  {{subPic2.realChar}}<br>
  <div class="gray-text"{{subPic2.realVoiceChar}}</div>
  {{subPic2.korChar}}<br>
  <div class="gray-text"{{subPic2.korVoiceChar}}</div>
  </div>
  {{/subPic2.realChar}}

  {{#subPic3.realChar}}
  <div class="image-item">
  <img src="../../images/pic/anime/{{subPic3.pic}}" class="addImage_m" alt="등장인물3"></img>
  {{subPic3.realChar}}<br>
  <div class="gray-text"{{subPic3.realVoiceChar}}</div>
  {{subPic3.korChar}}<br>
  <div class="gray-text"{{subPic3.korVoiceChar}}</div>
  </div>
  {{/subPic3.realChar}}
  
  {{#subPic4.realChar}}
  <div class="image-item">
  <img src="../../images/pic/anime/{{subPic4.pic}}" class="addImage_m" alt="등장인물4"></img>
  {{subPic4.realChar}}<br>
  <div class="gray-text"{{subPic4.realVoiceChar}}</div>
  {{subPic4.korChar}}<br>
  <div class="gray-text"{{subPic4.korVoiceChar}}</div>
  </div>
  {{/subPic4.realChar}}

  {{#subPic5.realChar}}
  <div class="image-item">
  <img src="../../images/pic/anime/{{subPic5.pic}}" class="addImage_m" alt="등장인물5"></img>
  {{subPic5.realChar}}<br>
  <div class="gray-text"{{subPic5.realVoiceChar}}</div>
  {{subPic5.korChar}}<br>
  <div class="gray-text"{{subPic5.korVoiceChar}}</div>
  </div>
  {{/subPic5.realChar}}


</div>
</br> 



<!--전체 리뷰-->
<h5>전체리뷰</h5>
전체 평점 : {{avg_score}}/5.0 리뷰 수 : {{c_score}}<br>
<hr>
<span class="review-toggle">전체리뷰 보기</span>
<div class="review-content">
{{#reviewDtos}}
<div id="scoreForm" class="review">
    <fieldset disabled>
      <div>
          <input type="radio" name="rate-{{id}}" value="5" id="rate5-{{id}}" disabled><label for="rate5-{{id}}">♣</label>
          <input type="radio" name="rate-{{id}}" value="4" id="rate4-{{id}}" disabled><label for="rate4-{{id}}">♣</label>
          <input type="radio" name="rate-{{id}}" value="3" id="rate3-{{id}}" disabled><label for="rate3-{{id}}">♣</label>
          <input type="radio" name="rate-{{id}}" value="2" id="rate2-{{id}}" disabled><label for="rate2-{{id}}">♣</label>
          <input type="radio" name="rate-{{id}}" value="1" id="rate1-{{id}}" disabled><label for="rate1-{{id}}">♣</label>
        </div>
        <div>
          <p>작성자 : {{member_nickname}}</p>
          <p>한줄평 : {{score_reason}}</p><br>
        </div>
      </fieldset>
    <input type="hidden" class="score-value" value="{{score}}">
    <input type="hidden" class="review-id" value="{{id}}">
</div>

<hr>
{{/reviewDtos}}
</div>
<br>

<!--나의 리뷰-->
{{#my_review}}
<div class="card mb-3" id="reviews-{{id}}">
  <div class="card-body">
<div id="review-section">
  <div id="reviews">
    <p>나의 리뷰</p>
    <p>평점 : {{score}} 점</p>
    <!--태그내용-->
    <p>한줄평 : {{score_reason}}</p><br>
  </div>
  <button type="button"
    class="btn btn-sm btn-primary"
    data-bs-toggle="modal"
    data-bs-target="#review-edit-modal"
    data-bs-id="{{id}}"
    data-bs-score="{{score}}"
    data-bs-score_reason="{{score_reason}}"
    data-bs-member-id="{{member_id}}"
    data-bs-article-id="{{article_id}}">수정</button>
  <button type="button"
    class="btn btn-sm btn-outline-danger review-delete-btn"
    data-review-id="{{id}}" data-review-title="{{title}}" data-article-id="{{article_id}}">삭제</button>
</div>
</div>
</div>

{{/my_review}}

{{^my_review}}
<!--로그인ㅇ&리뷰x-->
  <!--<link href="/resources/templates/layouts/css.mustache" rel="stylesheet"/>-->
  <!--<form class="mb-3" name="starform" action="/articles/{{id}}/create_r" id="scoreForm" method="post">-->
  <form class="mb-3" name="starform" id="scoreForm">


    <input type="hidden" id="member-id" value="{{member_id}}"><br>
    <input type="hidden" id="article-id" value="{{id}}"><br>
    <span class="text-bold">작품에 평점을 표시해주세요</span><br>
    <fieldset>
      
      <input type="radio" name="score" value="5" id="rate1"><label
        for="rate1">♣</label>
      <input type="radio" name="score" value="4" id="rate2"><label
        for="rate2">♣</label>
      <input type="radio" name="score" value="3" id="rate3"><label
        for="rate3">♣</label>
      <input type="radio" name="score" value="2" id="rate4"><label
        for="rate4">♣</label>
      <input type="radio" name="score" value="1" id="rate5"><label
        for="rate5">♣</label>
    </fieldset>
    <ul>
      {{#tags}}
      <li>
          <span>{{tag}}</span>
          <input type="checkbox" id="tag_{{id}}" name="selectedTags" value="{{id}}">
          <button type="button" onclick="toggleTag({{id}})">Toggle</button>
      </li>
      {{/tags}}
  </ul>
    <div>
      <textarea class="col-auto form-control" type="text" id="score-reason"
            placeholder="간단하게 해당 점수를 택한 이유를 적어주세요."></textarea>
    </div>

    <button type="button" class="btn btn-primary" id="reviewCreateBtn">리뷰 작성</button>
  </form>	
{{/my_review}}

<!--리뷰수정-->
<!-- Modal -->
<div class="modal fade" id="review-edit-modal" tabindex="-1"">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5"
            id="exampleModalLabel">리뷰 수정</h1>
        <button type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!--댓글 수정 폼-->
        <form>
            <!--평점 입력-->
            <div class="mb-3">
              <label class="form-label">평점</label>
              <div class="editReview" name="starform" id="scoreForm">
                <span class="text-bold">작품에 평점을 표시해주세요</span><br>
                <fieldset>
                  <input type="radio" name="score" value="5" id="rate1"><label
                    for="rate1">♣</label>
                  <input type="radio" name="score" value="4" id="rate2"><label
                    for="rate2">♣</label>
                  <input type="radio" name="score" value="3" id="rate3"><label
                    for="rate3">♣</label>
                  <input type="radio" name="score" value="2" id="rate4"><label
                    for="rate4">♣</label>
                  <input type="radio" name="score" value="1" id="rate5"><label
                    for="rate5">♣</label>
                </fieldset>
                <input type="hidden" id="member-id" value="{{member_id}}"><br>
                <input type="hidden" id="article-id" value="{{id}}"><br>
              </div>	

            </div>
            <!--한줄평 입력-->
            <div class="mb-3">
            <textarea class="col-auto form-control" type="text" id="edit-review-score_reason"
                        placeholder="간단하게 해당 점수를 택한 이유를 적어주세요."></textarea>
            </div>
            <!--히든 인풋-->
                <input type="hidden" id="edit-review-id">
                <input type="hidden" id="edit-review-member-id">
                <input type="hidden" id="edit-review-article-id"">
            <!--전송 버튼-->
            <button type="button" class="btn btn-primary"
                id="review-update-btn">수정 완료</button>
        </form>
      </div>
      
    </div>
  </div>
</div>
<!-- 삭제 확인 모달 -->
<div class="modal fade" id="review-delete-confirm-modal" tabindex="-1" aria-labelledby="reviewDeleteConfirmLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ReviewDeleteConfirmLabel">리뷰 삭제</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        정말로 이 리뷰를 삭제하시겠습니까?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">아니오</button>
        <button type="button" class="btn btn-danger" id="confirm-review-delete-btn">예</button>
      </div>
    </div>
  </div>
</div>

{{/article}}
  <a href="/articles/anime/{{id}}/edit" class="btn btn-sm btn-primary">게시글 수정</a>
  <a href="/articles/anime/{{id}}/delete" class="btn btn-sm btn-outline-danger">게시글 삭제</a>
  <a href="/articles/anime" class="btn btn-sm btn-success">작품 목록</a>
  
</div>

<script>
  {
    //전체리뷰 띄우기
    document.addEventListener("DOMContentLoaded", function() {
      const reviewToggle = document.querySelector('.review-toggle');
      const reviewContent = document.querySelector('.review-content');
      //초기에 reviewContent 접은 상태로 설정
      reviewContent.style.display = 'none';

      reviewToggle.addEventListener('click', function() {
        reviewContent.classList.toggle('active');
        if (reviewContent.classList.contains('active')) {
            reviewToggle.textContent = '전체리뷰 접기';
            //리뷰 보이게
            reviewContent.style.display='block';
        } else {
              reviewToggle.textContent = '전체리뷰 펼치기';
              //리뷰 안보이게
              reviewContent.style.display='none';
          }
      });


      document.querySelectorAll(".review").forEach(function(card) {
          const score = card.querySelector(".score-value").value;
          const id = card.querySelector(".review-id").value;
          card.querySelector(`input[name="rate-${id}"][value="${score}"]`).checked = true;
      });

    //리뷰 생성 버튼 변수화
    const reviewCreateBtn=document.querySelector("#reviewCreateBtn");
    //이벤트 감지되면 이벤트 처리 함수 실행
    reviewCreateBtn.addEventListener("click",function(){
      //라디오 버튼에서 선택된 값을 가져오기 
      const scoreElement=document.querySelector('input[name="score"]:checked');
      //새 리뷰 객체 생성
      const review={
        //새 리뷰의 멤버id,게시글id,점수,한줄평
        member_id:document.querySelector("#member-id").value,
        article_id:document.querySelector("#article-id").value,
        score:scoreElement ? scoreElement.value : null,
        score_reason:document.querySelector("#score-reason").value
      };

      //선택된 라디오 버튼이 없는 경우 경고 메시지를 출력하고 함수 종료
      if(!scoreElement){
        alert('평점을 선택해주세요.');
        return;
      }


      //review객체를 확인하기 위해 콘솔에 출력(디버깅용, 추후 삭제하기)
       console.log(review);
      //review객체 서버에 post, 비동기 통신을 위한 fetch API
      const url="/api/articles/"+review.article_id+"/create_r"
      fetch(url,{
        method:"POST",
        headers:{
          "Content-Type": "application/json"
        },
        body: JSON.stringify(review)//review객체를 JSON 문자열로 변환해 전송
      }) 
      .then(response => {
        //HTTP 응답코드에 따른 메시지 출력
        const msg=(response.ok)?"리뷰 작성 완료 :)":"리뷰 작성 중 오류가 발생하였습니다.";
        alert(msg);
        //현재페이지 새로고침
        window.location.reload();
      })
      .then(data => {

        document.querySelector("#reviewCreateBtn").disabled = true;
        document.querySelector("#reviewCreateBtn").classList.add('hidden');

        const reviewSection = document.querySelector("#review-section");
        reviewSection.classList.remove('hidden');

        const reviewsDiv = document.querySelector("#reviews");
        reviewsDiv.innerHTML = `
            <div class="review">
                <p>Member ID: <span id="display_member_id">${review.member_id}</span></p>
                <p>Article ID: <span id="display_article_id">${review.article_id}</span></p>
                <p>Score: <span id="display_score">${review.score}</span></p>
                <p>Reason: <span id="display_score_reason">${review.score_reason}</span></p>
            </div>
        `;

    })
      .catch((error)=>{
        console.error('Error:',error);
      });
    })
    
  });
    
  }
  //모달 이벤트 처리
  {
    //모달 클릭 시 데이터 띄우기
        //모달 요소 선택
        const reviewEditModal=document.querySelector("#review-edit-modal");
        //모달 이벤트 감지
        reviewEditModal.addEventListener("show.bs.modal", function(event){
            //1. 트리거 버튼 선택(event.target은 모달 자체)
            const triggerBtn=event.relatedTarget;
            //2. 데이터 가져오기
            const id=triggerBtn.getAttribute("data-bs-id");
            const score=triggerBtn.getAttribute("data-bs-score");
            const score_reason=triggerBtn.getAttribute("data-bs-score_reason");
            const memberId=triggerBtn.getAttribute("data-bs-member-id");
            const articleId=triggerBtn.getAttribute("data-bs-article-id");
            //3. 수정 폼에 데이터 반영
            document.querySelector("#edit-review-id").value=id;
            //document.querySelector("#edit-review-score").value=score;
            document.querySelector("#edit-review-score_reason").value=score_reason;
            document.querySelector("#edit-review-member-id").value=memberId;
            document.querySelector("#edit-review-article-id").value=articleId;
            //리뷰 평점 선택되어있게
            document.querySelectorAll(".editReview").forEach(function(card) {
              card.querySelector(`input[name="score"][value="${score}"]`).checked = true;
          });
        });
   

  }
  {
    //REST API로 데이터 반영
        //수정 완료 버튼 선택
        const reviewUpdateBtn=document.querySelector("#review-update-btn");
        //클릭 이벤트 처리
        reviewUpdateBtn.addEventListener("click", function(){
            //라디오 버튼에서 선택된 값을 가져오기 
            const scoreElement=document.querySelector('input[name="score"]:checked');
            //수정 댓글 객체 생성
            const review={
                id: document.querySelector("#edit-review-id").value,
                score:scoreElement ? scoreElement.value : null,
                score_reason: document.querySelector("#edit-review-score_reason").value,
                memberId: document.querySelector("#edit-review-member-id").value,
                articleId: document.querySelector("#edit-review-article-id").value
            };
            console.log(review);
            //수정 REST API 호출
            const url="/api/reviews/"+review.id;
            fetch(url, {
                method: "PATCH",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(review)//review 객체를 JSON문자열로 변환 전송
            }).then(response=>{
                //HTTP 응답코드에 따른 메시지 출력
                const msg=(response.ok)?"리뷰가 수정됐습니다. ♪(^∇^*)":"리뷰 수정 실패! ~(>_<。)＼";
                alert(msg);
                //현재 페이지 새로고침
                window.location.reload();
            });
        });
  }
</script>
<!--리뷰 삭제-->
<script>
    {
        //삭제 버튼 선택
        const reviewDeleteBtns=document.querySelectorAll(".review-delete-btn");
        let reviewId, reviewTitle, articleId;

        //삭제 확인 모달의 예 버튼
        const confirmReviewDeleteBtn=document.getElementById('confirm-review-delete-btn');
        //삭제 버튼 이벤트 처리
        reviewDeleteBtns.forEach(btn => {
            btn.addEventListener("click", (event)=>{
                //이벤트 발생 요소 선택
                const reviewDeleteBtn=event.target;
                //삭제 리뷰 id 가져오기
                reviewId=reviewDeleteBtn.getAttribute("data-review-id");
                reviewTitle=reviewDeleteBtn.getAttribute("data-review-title");
                articleId=reviewDeleteBtn.getAttribute("data-article-id");
                console.log(`삭제 버튼 클릭: ${reviewId}번 댓글`);

                //삭제 확인 모달 띄우기
                const reviewDeleteConfirmModal=new bootstrap.Modal(document.getElementById('review-delete-confirm-modal'));
                reviewDeleteConfirmModal.show();
                
            });
        });
        confirmReviewDeleteBtn.addEventListener("click",()=>{
          //삭제 REST API 호출
                const url=`/api/reviews/${articleId}/${reviewId}`;
                fetch(url, {
                    method: "DELETE"
                }).then(response=>{
                    //리뷰 삭제 실패 처리
                    if(!response.ok){
                        alert("리뷰 삭제 실패..!");
                        return;
                    }
                    //삭제 성공 시 댓글을 화면에서 지우고 메시지 창 띄우기
                    const target=document.querySelector(`#reviews-${reviewId}`);
                    target.remove();
                    const msg=`"${reviewTitle}" 리뷰를 삭제했습니다.`;
                    alert(msg);
                    //현재 페이지 새로고침
                    window.location.reload();
                })
        })
    }
    {
      //tag선택
      function toggleTag(tagId) {
            const checkbox = document.getElementById('tag_' + tagId);
            checkbox.checked = !checkbox.checked;
        }
    }
</script>


<style>
  /* CSS */
.review {
 /*border: 1px solid #ccc;  테두리 선 스타일 */
  text-align: left;
  padding: 10px; /* 내부 여백 */
  margin-bottom: 10px; /* 아래쪽 마진 */
  background-color: #f9f9f9; /* 배경색 */
}

.review-toggle {
  cursor: pointer;
  color: blue;
  text-decoration: underline;
  display: block;
  margin-bottom: 5px;
}

.review-content {
  max-height: 700px; /* 리뷰 내용 최대 높이 */
  overflow-y: auto; /* 세로 스크롤 추가 */
}
.review p {
  margin: 5px 0; /* 각 정보(멤버 ID, 게시글 ID 등)의 위아래 마진 */
}

.review span {
    font-weight: bold; /* 정보(멤버 ID, 게시글 ID 등)의 텍스트를 굵게 설정 */
    color: #333; /* 텍스트 색상 */
}
</style>
{{>layouts/footer}}