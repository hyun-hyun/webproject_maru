{{>layouts/header}}
<div class="container">
    <br>
    <h2>ğŸ“šì‘í’ˆ ëª©ë¡</h2>
    <br>
    <hr>
    <div class="sort-buttons">
        <button onclick="sortArticles('id')" class="btn btn-primary">ë“±ë¡ì¼ì <span id="idSortIcon">â–¼</span></button>
        <button onclick="sortArticles('broaddate')" class="btn btn-primary">ë°©ì˜ì¼ì <span id="broadDateSortIcon"></span></button>
        <button onclick="sortArticles('avgscore')" class="btn btn-primary">í‰ì  <span id="avgScoreSortIcon"></span></button>
        <button onclick="sortArticles('cscore')" class="btn btn-primary">ë¦¬ë·°ìˆ˜ <span id="cscoreSortIcon"></span></button>
    </div>

    <div class="article-list" id="article-list">
        <!-- ë‚´ìš© -->
    </div>
    <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° -->
    <div id="loading" class="loading-container" style="display: none;">
        <div class="spinner"></div>
        <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
</div>

{{>layouts/footer}}

<script>
    let currentSort = 'id';
    let direction = 'desc';

    function sortArticles(sortBy) {
        if (currentSort === sortBy) {
            direction = direction === 'desc' ? 'asc' : 'desc';
        } else {
            currentSort = sortBy;
            direction = 'desc';
        }
        updateSortIcons();
        document.querySelector("#article-list").innerHTML = "";
        loadArticles(0, currentSort, direction);
    }

    function updateSortIcons() {
        const icons = {
            id: document.getElementById('idSortIcon'),
            broaddate: document.getElementById('broadDateSortIcon'),
            avgscore: document.getElementById('avgScoreSortIcon'),
            cscore: document.getElementById('cscoreSortIcon')
        };
        Object.keys(icons).forEach(key => icons[key].textContent = '');
        icons[currentSort].textContent = direction === 'desc' ? 'â–¼' : 'â–²';
    }
    let currentPage = 0; // í˜„ì¬ í˜ì´ì§€ (ë¬´í•œ ìŠ¤í¬ë¡¤ì„ ìœ„í•œ)
    let loading = false; // ë°ì´í„° ë¡œë”© ì¤‘ì¸ì§€ ì²´í¬
    let hasMoreData = true; // ë” ì´ìƒ ë°ì´í„°ê°€ ìˆëŠ”ì§€ ì²´í¬
    
    // ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë¡œë“œí•˜ëŠ” í•¨ìˆ˜
    function loadArticles(page, sort = 'id', direction = 'desc') {
        if (loading || !hasMoreData) return; // ì´ë¯¸ ë°ì´í„°ë¥¼ ë¡œë”© ì¤‘ì´ê±°ë‚˜ ë” ì´ìƒ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ìš”ì²­ì„ í•˜ì§€ ì•ŠìŒ
        loading = true;
        document.getElementById('loading').style.display = 'block'; // ë¡œë”© ì¸ë””ì¼€ì´í„° í‘œì‹œ
  
        const url =`/api/articles/list?page=${page}&sort=${sort}&direction=${direction}`;
    
        fetch(url)
            .then(response => response.json())
            .then(articles => {
                const articleListContainer = document.getElementById('article-list');
                if (articles.length === 0) {
                    hasMoreData = false;  // ë” ì´ìƒ ë¶ˆëŸ¬ì˜¬ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ hasMoreDataë¥¼ falseë¡œ ì„¤ì •
                    document.getElementById('loading').style.display = 'none'; // ë¡œë”© ìˆ¨ê¹€
                    return;
                }
    
                articles.forEach(article => {
                    const articleRow = document.createElement('tr');
                    articleRow.className = 'article-row';
                    articleRow.setAttribute('data-article-id', article.id);
    
                    let tagsHtml = '';
                    if (article.usedTags && Array.isArray(article.usedTags)) {
                        article.usedTags.forEach(tag => {
                            tagsHtml += `<span class="btn btn-outline-info m-1 tag">${tag}</span>`;
                        });
                    }
    
                    articleRow.innerHTML = `
                    <div class="article-content">
                      <img src="/images/pic/anime/${article.main_pic}" width="150" alt="ì‘í’ˆí‘œì§€" class="article-image">
                      <div class="article-info">
                          í‰ì  ${article.avgscore}ì  / ë¦¬ë·° ${article.cscore}ê°œ<br>
                          <b class="title">[${article.genre}] ${article.title}</b>
                          <div class="tags">${tagsHtml}</div>
                          <div class="meta-info">
                              ${article.broaddate} | ${article.author} | ${article.ani_company}
                          </div>
                          <span class="story">${article.story}</span>
                      </div>
                  </div>
                    `;
                    articleListContainer.appendChild(articleRow);
    
                    // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€ (ê²Œì‹œê¸€ í´ë¦­ ì‹œ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™)
                    articleRow.addEventListener('click', function() {
                        window.location.href = `/articles/anime/${article.id}`;
                    });
                });
    
                // ë¡œë”© ìƒíƒœ ì´ˆê¸°í™”
                loading = false;
                document.getElementById('loading').style.display = 'none'; // ë¡œë”© ìˆ¨ê¹€
            })
            .catch(error => {
                console.error('Error fetching articles:', error);
                loading = false;
                document.getElementById('loading').style.display = 'none'; // ë¡œë”© ìˆ¨ê¹€
            });
    }
    
    // ë¬´í•œ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ì²˜ë¦¬
    window.addEventListener('scroll', function() {
        const scrollPosition = window.innerHeight + window.scrollY;
        const documentHeight = document.documentElement.scrollHeight;
    
        // í˜ì´ì§€ í•˜ë‹¨ì— ë„ë‹¬í•˜ë©´ ë‹¤ìŒ í˜ì´ì§€ ë¡œë“œ
        if (scrollPosition >= documentHeight - 500 && hasMoreData && !loading) {
            currentPage++;
            loadArticles(currentPage); // ìƒˆë¡œìš´ í˜ì´ì§€ì˜ ê²Œì‹œê¸€ì„ ë¡œë“œ
        }
    });
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì²« ë²ˆì§¸ í˜ì´ì§€ì˜ ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ê¸°
    document.addEventListener('DOMContentLoaded', function() {
        const searchQuery = new URLSearchParams(window.location.search).get('search'); // URLì—ì„œ search íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
        loadArticles(currentPage); // ì²« ë²ˆì§¸ í˜ì´ì§€ ë¡œë“œ
    });
  </script>

<style>
  /* ë¡œë”© ì»¨í…Œì´ë„ˆ */
  .loading-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
      color: #3498db;
      font-family: 'Arial', sans-serif;
      font-size: 16px;
      text-align: center;
  }
  
  /* ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ */
  .spinner {
      border: 4px solid #f3f3f3; /* ë°°ê²½ ìƒ‰ */
      border-top: 4px solid #3498db; /* ìŠ¤í”¼ë„ˆ ìƒ‰ */
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite; /* ìŠ¤í”¼ë„ˆ íšŒì „ ì• ë‹ˆë©”ì´ì…˜ */
  }
  
  /* íšŒì „ ì• ë‹ˆë©”ì´ì…˜ */
  @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
  }
  
  /* í…ìŠ¤íŠ¸ ì•„ë˜ì— ê°„ê²© ì¶”ê°€ */
  #loading p {
      margin-top: 10px;
      font-size: 18px;
      color: #555;
  }

  .article-list {
    margin-top: 30px;
    display: flex;
    flex-direction: column;
    gap: 20px; /* ê° ì¶”ì²œ í•­ëª© ê°„ ê°„ê²© */
}

/* ë°˜ì‘í˜• ë””ìì¸ */
@media (max-width: 768px) {
    .article-content {
        flex-direction: column; /* ëª¨ë°”ì¼ì—ì„œëŠ” ì„¸ë¡œë¡œ ìŒ“ì´ê²Œ */
        align-items: flex-start;
    }

    .article-image {
        margin-right: 0;
        margin-bottom: 15px;
    }
}
</style>