{{>layouts/header}}
<div class="container">
    <br>
    <h2>ğŸ“šì‘í’ˆ ëª©ë¡</h2>
    <br>
    <hr>
    <div class="sort-buttons">
        <button onclick="sortArticles('id')" class="btn btn-primary">ë“±ë¡ì¼ì <span id="idSortIcon">â–¼</span></button>
        <button onclick="sortArticles('broaddate')" class="btn btn-primary">ë°©ì˜ì¼ì <span id="broadDateSortIcon"></span></button>
        <button onclick="sortArticles('avgscore')" class="btn btn-primary">í‰ì  <span id="avgScoreSortIcon"></span></button>
        <button onclick="sortArticles('cscore')" class="btn btn-primary">ë¦¬ë·°ìˆ˜ <span id="cscoreSortIcon"></span></button>
    </div>

    <div class="article-list" id="article-list">
        <!-- ë‚´ìš© -->
    </div>
    <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° -->
    <div id="loading" class="loading-container" style="display: none;">
        <div class="spinner"></div>
        <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
</div>

{{>layouts/footer}}

<script>
    let currentSort = new URLSearchParams(window.location.search).get('sort') || 'id';
    let direction = new URLSearchParams(window.location.search).get('direction') || 'desc';
    let currentPage = parseInt(new URLSearchParams(window.location.search).get('page')) || 0;
    let loading = false;
    let hasMoreData = true;

    // URL ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateURLState() {
        const params = new URLSearchParams();
        params.set('sort', currentSort);
        params.set('direction', direction);
        params.set('page', currentPage);
        history.replaceState(null, '', `?${params.toString()}`);
    }

    // ì •ë ¬ ë³€ê²½
    function sortArticles(sortBy) {
        if (currentSort === sortBy) {
            direction = direction === 'desc' ? 'asc' : 'desc';
        } else {
            currentSort = sortBy;
            direction = 'desc';
        }
        currentPage = 0; // ì •ë ¬ ë³€ê²½ ì‹œ í˜ì´ì§€ ì´ˆê¸°í™”
        hasMoreData = true;
        loading = false;
        updateSortIcons();
        document.querySelector("#article-list").innerHTML = ""; // ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™”
        loadArticles(currentPage, currentSort, direction); // ìƒˆë¡œ ë¡œë“œ
        updateURLState();
    }

    // ì •ë ¬ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
    function updateSortIcons() {
        const icons = {
            id: document.getElementById('idSortIcon'),
            broaddate: document.getElementById('broadDateSortIcon'),
            avgscore: document.getElementById('avgScoreSortIcon'),
            cscore: document.getElementById('cscoreSortIcon'),
        };
        Object.keys(icons).forEach(key => (icons[key].textContent = ''));
        icons[currentSort].textContent = direction === 'desc' ? 'â–¼' : 'â–²';
    }

    // ì‘í’ˆ ë¡œë“œ
    // ì‘í’ˆ ë¡œë“œ (ë¹„ë™ê¸° ì‘ì—… ì™„ë£Œ í›„ ìŠ¤í¬ë¡¤ ë³µêµ¬)
    async function loadArticles(page, sort = 'id', direction = 'desc') {
        if (loading || !hasMoreData) return;
        loading = true;
        document.getElementById('loading').style.display = 'block';

        const url = `/api/articles/list?page=${page}&sort=${sort}&direction=${direction}`;
        try {
            const response = await fetch(url);
            const articles = await response.json();
            const articleListContainer = document.getElementById('article-list');
            
            if (articles.length === 0) {
                hasMoreData = false;
                document.getElementById('loading').style.display = 'none';
                return;
            }

            // ì•„í‹°í´ì„ ë¡œë“œí•œ í›„ í‘œì‹œ
            articles.forEach(article => {
                const articleRow = document.createElement('div');
                articleRow.className = 'article-row';
                articleRow.setAttribute('data-article-id', article.id);

                let tagsHtml = '';
                if (article.usedTags && Array.isArray(article.usedTags)) {
                    tagsHtml = article.usedTags
                        .map(tag => `<span class="btn btn-outline-info m-1 tag">${tag}</span>`)
                        .join('');
                }

                articleRow.innerHTML = `
                    <div class="article-content">
                        <img src="/images/pic/anime/${article.main_pic}" width="150" alt="ì‘í’ˆí‘œì§€" class="article-image">
                        <div class="article-info">
                            í‰ì  ${article.avgscore}ì  / ë¦¬ë·° ${article.cscore}ê°œ<br>
                            <b class="title">[${article.genre}] ${article.title}</b>
                            <div class="tags">${tagsHtml}</div>
                            <div class="meta-info">
                                ${article.broaddate} | ${article.author} | ${article.ani_company}
                            </div>
                            <span class="story">${article.story}</span>
                        </div>
                    </div>
                `;
                articleListContainer.appendChild(articleRow);

                // ìƒì„¸ í˜ì´ì§€ ì´ë™ ì‹œ ìƒíƒœ ì €ì¥
                articleRow.addEventListener('click', function () {
                    sessionStorage.setItem('scrollPosition', window.scrollY);
                    updateURLState();
                    window.location.href = `/articles/anime/${article.id}`;
                });
            });

            loading = false;
            document.getElementById('loading').style.display = 'none';

            // ëª¨ë“  ì•„í‹°í´ ë¡œë”© ì™„ë£Œ í›„ ìŠ¤í¬ë¡¤ ë³µêµ¬
            restoreScrollPosition();
        } catch (error) {
            console.error('Error fetching articles:', error);
            loading = false;
            document.getElementById('loading').style.display = 'none';
        }
    }

    // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³µêµ¬
    function restoreScrollPosition() {
        let scrollPosition = sessionStorage.getItem('scrollPosition');
        scrollPosition = parseInt(scrollPosition, 10);

        if (!isNaN(scrollPosition)) {
            window.scrollTo(0, scrollPosition);
            //console.log('ìŠ¤í¬ë¡¤ ì´ë™ ì™„ë£Œ');
        } else {
            //console.log('ìœ íš¨í•˜ì§€ ì•Šì€ ìŠ¤í¬ë¡¤ ìœ„ì¹˜');
        }

        sessionStorage.removeItem('scrollPosition'); // ë³µêµ¬ í›„ ì œê±°
    }

        // ë¬´í•œ ìŠ¤í¬ë¡¤
        window.addEventListener('scroll', function () {
            const scrollPosition = window.innerHeight + window.scrollY;
            const documentHeight = document.documentElement.scrollHeight;

            if (scrollPosition >= documentHeight - 500 && hasMoreData && !loading) {
                currentPage++;
                loadArticles(currentPage, currentSort, direction);
                updateURLState();
            }
        });

        document.addEventListener('DOMContentLoaded', async function () {
            // ëª¨ë“  í˜ì´ì§€ì˜ ì•„í‹°í´ì„ ë¹„ë™ê¸°ì ìœ¼ë¡œ ë¡œë“œ
            for (let i = 0; i <= currentPage; i++) {
                await loadArticles(i, currentSort, direction); // ì €ì¥ëœ ìƒíƒœë¡œ ëª©ë¡ ë¡œë“œ
            }
            //console.log(currentPage);
            updateSortIcons(); // ì •ë ¬ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
        
            // ëª¨ë“  ë¦¬ì†ŒìŠ¤ê°€ ë¡œë“œëœ í›„ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³µêµ¬
            window.addEventListener('load', function() {
                restoreScrollPosition(); // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³µêµ¬
            });
        });
        window.addEventListener('popstate', function () {
            restoreScrollPosition(); // ë’¤ë¡œê°€ê¸° ì‹œ ìŠ¤í¬ë¡¤ ë³µêµ¬
        });
</script>


<style>
  /* ë¡œë”© ì»¨í…Œì´ë„ˆ */
  .loading-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
      color: #3498db;
      font-family: 'Arial', sans-serif;
      font-size: 16px;
      text-align: center;
  }
  
  /* ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ */
  .spinner {
      border: 4px solid #f3f3f3; /* ë°°ê²½ ìƒ‰ */
      border-top: 4px solid #3498db; /* ìŠ¤í”¼ë„ˆ ìƒ‰ */
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite; /* ìŠ¤í”¼ë„ˆ íšŒì „ ì• ë‹ˆë©”ì´ì…˜ */
  }
  
  /* íšŒì „ ì• ë‹ˆë©”ì´ì…˜ */
  @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
  }
  
  /* í…ìŠ¤íŠ¸ ì•„ë˜ì— ê°„ê²© ì¶”ê°€ */
  #loading p {
      margin-top: 10px;
      font-size: 18px;
      color: #555;
  }

  .article-list {
    margin-top: 30px;
    display: flex;
    flex-direction: column;
    gap: 20px; /* ê° ì¶”ì²œ í•­ëª© ê°„ ê°„ê²© */
}

/* ë°˜ì‘í˜• ë””ìì¸ */
@media (max-width: 768px) {
    .article-content {
        flex-direction: column; /* ëª¨ë°”ì¼ì—ì„œëŠ” ì„¸ë¡œë¡œ ìŒ“ì´ê²Œ */
        align-items: flex-start;
    }

    .article-image {
        margin-right: 0;
        margin-bottom: 15px;
    }
}
</style>