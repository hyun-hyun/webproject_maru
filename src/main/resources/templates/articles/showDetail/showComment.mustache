<!--ëŒ“ê¸€-->
<h4>ëŒ“ê¸€</h4>
<form id="commentForm">
    <input type="hidden" name="article-id" value="{{article.id}}">
    {{#member_id}}
    <input type="hidden" id="member-id" value="{{.}}"><br>
    {{/member_id}}
    <textarea class="col-auto form-control" type="text" id="body" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    <button type="button" class="btn btn-primary" id="commentCreateBtn">ëŒ“ê¸€ ì‘ì„±</button>
</form>
<br>
<div id="comment-list">
    <!--ëŒ“ê¸€ëª©ë¡-->
</div>
<br>
    

<script>
    //ëŒ“ê¸€
    //member-id ìš”ì†Œì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
      const memberIdElement = document.querySelector("#member-id");
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ëŒ“ê¸€ê³¼ ë‹µê¸€ì„ ì„œë²„ì—ì„œ ê°€ì ¸ì™€ì„œ í‘œì‹œ
    window.addEventListener('load', function() {
        const articleId = document.querySelector("input[name='article-id']").value; // ê²Œì‹œê¸€ ID ê°€ì ¸ì˜¤ê¸°
        
        fetch(`/api/comments/article/${articleId}`)
            .then(response => response.json())
            .then(comments => {
                const commentList = document.getElementById("comment-list");
                commentList.innerHTML = ''; // ê¸°ì¡´ ëŒ“ê¸€ ëª©ë¡ ì´ˆê¸°í™”
  
                // ëŒ“ê¸€ê³¼ ë‹µê¸€ì„ ë Œë”ë§
                comments.forEach(comment => {
              if(comment.parent_id==null){
  
                    const commentDiv = createCommentDiv(comment); // ëŒ“ê¸€ì„ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
                    commentList.appendChild(commentDiv);
              }
  
                });
            })
            .catch(error => {
                console.error('ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
            });
    });
  
    // ëŒ“ê¸€ ìƒì„± í•¨ìˆ˜
    function createCommentDiv(comment) {
      const commentDiv = document.createElement('div');
        
        
        // ëŒ“ê¸€ ë‚´ìš©
        if(comment.parent_id==null){
        commentDiv.classList.add('comment');
        commentDiv.setAttribute('id', `comment-${comment.id}`);
  
          if(comment.appendTime===comment.updateTime){
          commentDiv.innerHTML = `
              <p><b>${comment.nickname}</b> ${comment.appendTime}</p>
              <p>${comment.body}</p>
              <button onclick="toggleReplyBox(${comment.id}, '${comment.nickname}')">ë‹µê¸€ ë‹¬ê¸°</button>
              <button onclick="openEditModal(${comment.id})">ìˆ˜ì •</button>
              <button onclick="deleteComment(${comment.id})">ì‚­ì œ</button>
              <div id="replies-${comment.id}" class="replies"></div>
          `;}else{
            commentDiv.innerHTML = `
              <p><b>${comment.nickname}</b> ${comment.appendTime}(ìˆ˜ì •ë¨)</p>
              <p>${comment.body}</p>
              <button onclick="toggleReplyBox(${comment.id}, '${comment.nickname}')">ë‹µê¸€ ë‹¬ê¸°</button>
              <button onclick="openEditModal(${comment.id})">ìˆ˜ì •</button>
              <button onclick="deleteComment(${comment.id})">ì‚­ì œ</button>
              <div id="replies-${comment.id}" class="replies"></div>
          `;
          }
        }else{
          commentDiv.classList.add('reply');
          commentDiv.setAttribute('id', `reply-${comment.id}`);
          if(comment.appendTime===comment.updateTime){
            commentDiv.innerHTML = `
              <p>ğŸ‘‰ <b>${comment.nickname}</b> ${comment.appendTime}</p>
              <p><strong>@${comment.parent_nickname}</strong> ${comment.body}</p>
              <button onclick="toggleReplyBox(${comment.id}, '${comment.nickname}')">ë‹µê¸€ ë‹¬ê¸°</button>
              <button onclick="openEditModal(${comment.id})">ìˆ˜ì •</button>
              <button onclick="deleteComment(${comment.id})">ì‚­ì œ</button>
              <div id="replies-${comment.id}" class="replies"></div>
          `;}else{
            commentDiv.innerHTML = `
              <p>ğŸ‘‰ <b>${comment.nickname}</b> ${comment.appendTime}(ìˆ˜ì •ë¨)</p>
              <p><strong>@${comment.parent_nickname}</strong> ${comment.body}</p>
              <button onclick="toggleReplyBox(${comment.id}, '${comment.nickname}')">ë‹µê¸€ ë‹¬ê¸°</button>
              <button onclick="openEditModal(${comment.id})">ìˆ˜ì •</button>
              <button onclick="deleteComment(${comment.id})">ì‚­ì œ</button>
              <div id="replies-${comment.id}" class="replies"></div>
          `;
          }
        }
        
        // ë‹µê¸€ì„ ë Œë”ë§
        if (comment.replies && comment.replies.length > 0) {
            const repliesContainer = commentDiv.querySelector(`#replies-${comment.id}`);
            comment.replies.forEach(reply => {
                const replyDiv = createCommentDiv(reply); // ë‹µê¸€ë„ ëŒ“ê¸€ê³¼ ë™ì¼í•˜ê²Œ ìƒì„±
                repliesContainer.appendChild(replyDiv);
            });
        }
    
        return commentDiv;
    }
    
  
  
    //ëŒ“ê¸€ ìƒì„± ë²„íŠ¼ ë³€ìˆ˜í™”
    const commentCreateBtn=document.querySelector("#commentCreateBtn");
    //ì´ë²¤íŠ¸ ê°ì§€ë˜ë©´ ì´ë²¤íŠ¸ ì²˜ë¦¬ í•¨ìˆ˜ ì‹¤í–‰
    commentCreateBtn.addEventListener("click",function(){
            
      // member_idê°€ ì—†ì„ ê²½ìš° ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
      if (!memberIdElement || !memberIdElement.value) {
        const currentUrl = window.location.href; // í˜„ì¬ URL ê°€ì ¸ì˜¤ê¸°
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = "/login?continue=" + encodeURIComponent(currentUrl); // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™, í˜„ì¬ URL í¬í•¨
        return; // í•¨ìˆ˜ ì¢…ë£Œ
      }
      //ìƒˆ ëŒ“ê¸€ ê°ì²´ ìƒì„±
      const bodyElement=document.querySelector("#body")
      const comment={
        member_id:memberIdElement.value,
        article_id:document.querySelector("#article-id").value,
        body: bodyElement ?bodyElement.value:null
      };
      //ë‚´ìš© ë¯¸ì‘ì„±ì‹œ ê²½ê³  ë©”ì‹œì§€ ì¶œë ¥ í›„ í•¨ìˆ˜ ì¢…ë£Œ
      if (!bodyElement || bodyElement.value.trim() === "") {
        alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      console.log(comment);
  
    const url="/api/comments/create_c"
      fetch(url,{
        method:"POST",
        headers:{
          "Content-Type": "application/json"
        },
        body: JSON.stringify(comment)//commentê°ì²´ë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜í•´ ì „ì†¡
      })
      .then(response =>  {
        //HTTP ì‘ë‹µì½”ë“œì— ë”°ë¥¸ ë©”ì‹œì§€ ì¶œë ¥
        const msg=(response.ok)?"ëŒ“ê¸€ ì‘ì„± ì™„ë£Œ! ":"ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.";
        if(response.ok){
          alert(msg);
          return response.json();
        }else{
          alert(msg);
        }
      })
      .then(data => {
  
        // ì‘ë‹µì´ ì„±ê³µì ì´ë©´ ëŒ“ê¸€ì„ í™”ë©´ì— ì¶”ê°€
          if (data) {
              const commentList = document.getElementById("comment-list");
              const newCommentDiv = document.createElement("div");
              newCommentDiv.classList.add("comment");
              newCommentDiv.setAttribute("id", "comment-" + data.id);
  
              // ëŒ“ê¸€ ë‚´ìš© ì‘ì„±
              if(data.appendTime===data.updateTime){
  
              newCommentDiv.innerHTML = `
                <p><b>${data.nickname}</b> ${data.appendTime}</p>
                <p>${data.body}</p>
                <button onclick="toggleReplyBox(${data.id}, '${data.nickname}')">ë‹µê¸€ ë‹¬ê¸°</button>
                <button onclick="openEditModal(${data.id})">ìˆ˜ì •</button>
                <button onclick="deleteComment(${data.id})">ì‚­ì œ</button>
                <div class="replies" id="replies-${data.id}"></div>
              `;
            }else{
              newCommentDiv.innerHTML = `
                <p><b>${data.nickname}</b> ${data.appendTime}(ìˆ˜ì •ë¨)</p>
                <p>${data.body}</p>
                <button onclick="toggleReplyBox(${data.id}, '${data.nickname}')">ë‹µê¸€ ë‹¬ê¸°</button>
                <button onclick="openEditModal(${data.id})">ìˆ˜ì •</button>
                <button onclick="deleteComment(${data.id})">ì‚­ì œ</button>
                <div class="replies" id="replies-${data.id}"></div>
              `;
            }
              commentList.appendChild(newCommentDiv);
              
              // ëŒ“ê¸€ ì‘ì„± í›„ ë‚´ìš© ì´ˆê¸°í™”
              document.querySelector("#body").value = "";
          } else {
              alert("ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.");
          }
      })
      .catch((error)=>{
        console.error('Error:',error);
      });
  
    });
      // ë‹µê¸€ ì…ë ¥ ë°•ìŠ¤ í‘œì‹œ
      function toggleReplyBox(commentId, nickname) {
        const repliesContainer = document.querySelector(`#replies-${commentId}`);
        const existingReplyBox = document.querySelector(`#reply-box-${commentId}`);
      
        // ë‹µê¸€ ì…ë ¥ ë°•ìŠ¤ê°€ ì—†ìœ¼ë©´ ìƒì„±
        if (!existingReplyBox) {
          const replyBox = document.createElement("div");
          replyBox.setAttribute('id', `reply-box-${commentId}`);
          replyBox.classList.add('reply-box');
      
          // ë‹µê¸€ ì…ë ¥ì°½ ë° ë²„íŠ¼ ìƒì„±
          replyBox.innerHTML = `
            <textarea placeholder="@${nickname} ë‹˜ì—ê²Œ ë‹µê¸€ì„ ë‚¨ê¸°ì„¸ìš”..." rows="3" class="reply-input"></textarea>
            <button onclick="submitReply(${commentId})">ë‹µê¸€ ë‹¬ê¸°</button>
          `;
      
          repliesContainer.appendChild(replyBox);
        } else {
          // ì´ë¯¸ ì¡´ì¬í•˜ë©´ ìˆ¨ê¹€
          repliesContainer.removeChild(existingReplyBox);
        }
      }
  
      // ë‹µê¸€ ì‘ì„±
      function submitReply(parentCommentId) {
          const replyBox = document.querySelector(`#reply-box-${parentCommentId} .reply-input`);
          const body = replyBox.value;
          const bodyContent=body.trim();
          const article_id = document.querySelector("input[name='article-id']").value;
  
          // member_idê°€ ì—†ì„ ê²½ìš° ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
          if (!memberIdElement || !memberIdElement.value) {
            const currentUrl = window.location.href; // í˜„ì¬ URL ê°€ì ¸ì˜¤ê¸°
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = "/login?continue=" + encodeURIComponent(currentUrl); // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™, í˜„ì¬ URL í¬í•¨
            return; // í•¨ìˆ˜ ì¢…ë£Œ
          }
  
          if(!bodyContent){
            alert('ë‹µê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
          }
  
          fetch(`/api/comments/reply`, {
              method: "POST",
              headers: {
                  "Content-Type": "application/json",
              },
              body: JSON.stringify({
                member_id:memberIdElement.value,
                article_id: article_id,
                body: body,
                parent_id: parentCommentId
              }),
          })
          .then(response =>  {
            //HTTP ì‘ë‹µì½”ë“œì— ë”°ë¥¸ ë©”ì‹œì§€ ì¶œë ¥
            const msg=(response.ok)?"ë‹µê¸€ ì‘ì„± ì™„ë£Œ! ":"ë‹µê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.";
            if(response.ok){
              alert(msg);
              return response.json();
            }else{
              alert(msg);
            }
          })
          .then(data => {
      
            // ì‘ë‹µì´ ì„±ê³µì ì´ë©´ ë‹µê¸€ì„ í™”ë©´ì— ì¶”ê°€
              if (data) {
                const repliesContainer = document.getElementById("replies-" + parentCommentId);
                const newReplyDiv = document.createElement("div");
                newReplyDiv.classList.add("reply");
    
                // ë‹µê¸€ ë‚´ìš© ì‘ì„±
                if(data.appendTime===data.updateTime){
                  newReplyDiv.innerHTML = `
                  <p>ğŸ‘‰ <b>${data.nickname}</b> ${data.appendTime}</p>
                  <p><strong>@${data.parent_nickname}</strong> ${data.body}</p>
                  <button onclick="toggleReplyBox(${data.id}, '${data.nickname}')">ë‹µê¸€ ë‹¬ê¸°</button>
                  <button onclick="openEditModal(${data.id})">ìˆ˜ì •</button>
                  <button onclick="deleteComment(${data.id})">ì‚­ì œ</button>
                  <div id="replies-${data.id}" class="replies"></div>
                  `;
                }else{
                newReplyDiv.innerHTML = `
                  <p>ğŸ‘‰ <b>${data.nickname}</b> ${data.appendTime}(ìˆ˜ì •ë¨)</p>
                  <p><strong>@${data.parent_nickname}</strong> ${data.body}</p>
                  <button onclick="toggleReplyBox(${data.parent_id}, '${data.parent_nickname}')">ë‹µê¸€ ë‹¬ê¸°</button>
                  <button onclick="openEditModal(${data.id})">ìˆ˜ì •</button>
                  <button onclick="deleteComment(${data.id})">ì‚­ì œ</button>
                  <div id="replies-${data.id}" class="replies"></div>
                  `;}
                repliesContainer.appendChild(newReplyDiv);
    
                // ë‹µê¸€ ì‘ì„± ë°•ìŠ¤ ì´ˆê¸°í™”
                replyBox.value = "";
                // ë‹µê¸€ ë°•ìŠ¤ ë‹«ê¸°
                const replyBoxContainer = document.querySelector(`#reply-box-${parentCommentId}`);
                if (replyBoxContainer) {
                  replyBoxContainer.style.display = "none"; // ë‹µê¸€ ì‘ì„± ë°•ìŠ¤ë¥¼ ìˆ¨ê¹€
                }
            } 
        }).catch(error => {
          console.error('Error:', error);
        });
          
      }
    
  
      // ëŒ“ê¸€ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
      function openEditModal(commentId) {
          const modal = document.getElementById("editCommentModal");
          modal.style.display = "block";
          document.getElementById("editCommentContent").value = document.getElementById(`comment-content-${commentId}`).textContent;
          document.getElementById("saveEditButton").onclick = function() {
              saveEditedComment(commentId);
          };
      }
  
      // ëŒ“ê¸€ ìˆ˜ì •
      function saveEditedComment(commentId) {
          const body = document.getElementById("editCommentContent").value;
  
          fetch(`/api/comments/edit/${commentId}`, {
              method: "PATCH",
              headers: {
                  "Content-Type": "application/json",
              },
              body: JSON.stringify({
                  body: body
              }),
          })
          .then(response =>  {
            //HTTP ì‘ë‹µì½”ë“œì— ë”°ë¥¸ ë©”ì‹œì§€ ì¶œë ¥
            const msg=(response.ok)?"ëŒ“ê¸€ ìˆ˜ì • ì™„ë£Œ! ":"ëŒ“ê¸€ ìˆ˜ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.";
            alert(msg);
            //í˜„ì¬ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            window.location.reload();
          })
          
      }
  
      // ëŒ“ê¸€ ì‚­ì œ
      function deleteComment(commentId) {
          fetch(`/api/comments/delete/${commentId}`, {
              method: "DELETE",
          })
          .then(response=>{
            //ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨ ì²˜ë¦¬
            if(!response.ok){
              alert("ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨..!");
              return;
            }else{
              return response.json();
            }
            
        })
        .then(data => {
      
          // ì‘ë‹µì´ ì„±ê³µì 
            if (data) {
              const msg=`${data.nickname}ë‹˜ì˜ ëŒ“ê¸€ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.`;
            alert(msg);
            //í˜„ì¬ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            window.location.reload();
          } 
      });
      }
  
</script>
<style>
  .comment {
    margin-bottom: 20px;
  }
  
  .reply {
    margin-left: 20px;  /* ìµœëŒ€ í•œë²ˆë§Œ ë“¤ì—¬ì“°ê¸°, 20px */
    border-left: 2px solid #ccc;  /* ì™¼ìª½ì— ì„ ì„ ì¶”ê°€í•˜ì—¬ êµ¬ë¶„ */
    padding-left: 10px; /* ì„ ê³¼ í…ìŠ¤íŠ¸ ê°„ê²© */
    margin-top: 10px;
  }


    /* ë‹µê¸€ ë°•ìŠ¤ */
    .reply-box {
    margin-top: 10px;
    padding: 15px;
    background-color: #f9f9f9;
    border: 1px solid #e0e0e0;
    border-radius: 5px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    }

    .reply-input {
    width: 80%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 14px;
    }

    .reply-box button {
    background-color: #1e87f0;
    color: white;
    padding: 8px 16px;
    border-radius: 5px;
    border: none;
    cursor: pointer;
    }

    .reply-box button:hover {
    background-color: #155db5;
    }

    /* ëŒ“ê¸€ ì˜ì—­ */
    .comment p {
    font-size: 14px;
    color: #333;
    }

    .comment strong {
    color: #1e87f0;  /* ëŒ“ê¸€ ë¶€ëª¨ì˜ ë‹‰ë„¤ì„ ìƒ‰ìƒ */
    }

    /* ëŒ“ê¸€ ë‚´ ë²„íŠ¼ */
    button {
    background-color: #deeeff;
    color: #002954;
    border: none;
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
    margin: 5px;
    }

    button:hover {
    background-color: #87c1ff;
    }

    /* ë‹µê¸€ ì˜ì—­ */
    .replies {
    margin-top: 10px;
    }

    /* ë°˜ì‘í˜• ë””ìì¸ */
    @media (max-width: 600px) {
    .reply-input {
        width: 60%;
    }

    .reply-box button {
        width: 30%;
    }
    }
</style>