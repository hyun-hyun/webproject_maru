{{>layouts/header}}
<div class="container">
<br>
<h2>ë§ˆì´í˜ì´ì§€</h2>
<br>

<div class="recent-reviews">
    <h4>ìµœê·¼ ë¦¬ë·°í•œ ì‘í’ˆğŸ“‘</h4><br>
    <div class="article-list" id="article-list">
        <!-- Fetchëœ ë°ì´í„° -->
    </div>
    <div id="loading" class="loading-container" style="display: none;">
        <div class="spinner"></div>
        <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
</div>


<script>
    const memberId = {{member_id}}; 

    let currentPage = 0; // í˜„ì¬ í˜ì´ì§€ (0ë¶€í„° ì‹œì‘)
    let loading = false; // ë°ì´í„°ë¥¼ ë¡œë”© ì¤‘ì¸ì§€ ì—¬ë¶€
    let hasMoreData = true; // ë” ì´ìƒ ë°ì´í„°ê°€ ìˆëŠ”ì§€ ì²´í¬

    //ìµœê·¼ ë¦¬ë·°í•œ ì‘í’ˆ
    function loadReviewedArticles(page){
        if (loading || !hasMoreData) return; // ì´ë¯¸ ë°ì´í„°ë¥¼ ë¡œë”© ì¤‘ì´ê±°ë‚˜ ë” ì´ìƒ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ìš”ì²­ì„ í•˜ì§€ ì•ŠìŒ
        loading = true; // ë¡œë”© ì‹œì‘
        document.getElementById('loading').style.display = 'block'; // ë¡œë”© ì¸ë””ì¼€ì´í„° í‘œì‹œ

        //apií˜¸ì¶œ
        fetch(`/api/mypage/myreview/${memberId}?page=${page}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ ì‘ë‹µì…ë‹ˆë‹¤.');
                }
                return response.json();
            })
            .then(data => {
                const articleList = document.getElementById('article-list');
                if(data.length==0){
                    hasMoreData = false;  // ë” ì´ìƒ ë¶ˆëŸ¬ì˜¬ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ hasMoreDataë¥¼ falseë¡œ ì„¤ì •
                    document.getElementById('loading').style.display = 'none'; // ë¡œë”© ìˆ¨ê¹€
                    return;
                }

                data.forEach(articleReview => {
                    // ìƒˆë¡œìš´ div ìƒì„±
                    const articleItem = document.createElement('div');
                    articleItem.className = 'article-item';
                    articleItem.setAttribute('data-score', articleReview.score);

                    // HTML êµ¬ì„±
                    articleItem.innerHTML = `
                        <a href="/articles/anime/${articleReview.articleId}">
                            <div class="score"></div> <!-- ë³„ì„ í‘œì‹œí•  ë¶€ë¶„ -->
                            <img src="/images/pic/anime/${articleReview.main_pic}" alt="ë©”ì¸ì‚¬ì§„" class="main-pic">
                            <div class="title"><b>[${articleReview.genre}]${articleReview.title}</b></div>
                            <div class="score-reason">${articleReview.score_reason}</div>
                        </a>
                    `;

                    // article-itemì„ article-listì— ì¶”ê°€
                    articleList.appendChild(articleItem);
                });

                // ë³„ í‘œì‹œ í•¨ìˆ˜ í˜¸ì¶œ
                displayStars();
                // ì°½ í¬ê¸° ë³€ê²½ ì‹œ ë³„ í¬ê¸° ì¬ì¡°ì •
                window.addEventListener('resize', displayStars);
                //ë¡œë”©ìƒíƒœ falseë¡œ ë³€ê²½
                loading=false;
            })
            .catch(error => {
                console.error('Error fetching the data:', error);
                loading = false;
            })
            .finally(() => {
                document.getElementById('loading').style.display = 'none'; // ë¡œë”© ìˆ¨ê¹€
            });
    }
    
    // ë¬´í•œ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ì²˜ë¦¬
    window.addEventListener('scroll', function() {
        const scrollPosition = window.innerHeight + window.scrollY;
        const documentHeight = document.documentElement.scrollHeight;
    
        // í˜ì´ì§€ í•˜ë‹¨ì— ë„ë‹¬í•˜ë©´ ë‹¤ìŒ í˜ì´ì§€ ë¡œë“œ
        if (scrollPosition >= documentHeight - 500 && hasMoreData && !loading) {
            currentPage++;
            loadReviewedArticles(currentPage); // ìƒˆë¡œìš´ í˜ì´ì§€ì˜ ê²Œì‹œê¸€ì„ ë¡œë“œ
        }
    });
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì²« ë²ˆì§¸ í˜ì´ì§€ì˜ ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ê¸°
    document.addEventListener('DOMContentLoaded', function() {
        loadReviewedArticles(currentPage); // ì²« ë²ˆì§¸ í˜ì´ì§€ ë¡œë“œ
    });


    function displayStars() {
        const articles = document.querySelectorAll('.article-item');

        articles.forEach(article => {
            const score = parseInt(article.getAttribute('data-score')); // data-scoreì—ì„œ ì ìˆ˜ ê°€ì ¸ì˜¤ê¸°
            const starsContainer = article.querySelector('.score'); // ë³„ì„ í‘œì‹œí•  ìš”ì†Œ ì„ íƒ
            const imgElement = article.querySelector('.main-pic'); // í•´ë‹¹ ì•„í‹°í´ì˜ main-pic ì„ íƒ
    
            starsContainer.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì‚­ì œ
    
            if (imgElement) {
                const imgWidth = imgElement.width;  // ì´ë¯¸ì§€ì˜ ì‹¤ì œ ë„ˆë¹„ (150pxë¡œ ì„¤ì •)
                const starSize = imgWidth * 0.75 / 5; // ë³„ì˜ í¬ê¸°ë¥¼ ì´ë¯¸ì§€ì˜ 0.75ë°° í¬ê¸°ì—ì„œ 5ë“±ë¶„
    
                // ë³„ì„ í‘œì‹œ
                for (let i = 1; i <= 5; i++) {
                    const star = document.createElement('span');
                    star.className = 'star';
    
                    if (i <= score) {
                        star.textContent = 'â­'; // ì±„ì›Œì§„ ë³„
                    } else {
                        star.textContent = 'â˜†'; // ë¹ˆ ë³„
                    }
    
                    // ë³„ í¬ê¸° ì ìš©
                    star.style.fontSize = `${starSize}px`; // ë™ì ìœ¼ë¡œ ë³„ í¬ê¸° ì„¤ì •
                    starsContainer.appendChild(star);
                }
            }
        });
    }


</script>

<style>
    /*ë‚´ê°€ ì“´ ë¦¬ë·°*/
   .recent-reviews {
        margin-top: 20px;
    }
    
    .article-list {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start;  /* ì™¼ìª½ ì •ë ¬ */
    }
    
    .article-item {
        width: calc(20% - 10px); /* 5ê°œ ë‹¨ìœ„ë¡œ ê°€ë¡œ ë°°ì¹˜, ê°„ê²©ì„ ê³ ë ¤ */
        margin-bottom: 20px; /* ì„¸ë¡œ ê°„ê²© */
        position: relative; /* ìì‹ ìš”ì†Œì˜ ì ˆëŒ€ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì„¤ì • */
        padding: 15px;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .article-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
    }

    /* ëª¨ë°”ì¼ í™”ë©´ì—ì„œ í•œ ì¤„ì— 3ê°œì”© ë³´ì´ë„ë¡ ì„¤ì • */
    @media (max-width: 768px) {
        .article-item {
            width: calc(33.33% - 10px);  /*3ê°œê°€ í•œ ì¤„ì— í‘œì‹œë˜ë„ë¡ ì„¤ì • (ì—¬ë°± ê³ ë ¤) */
            /*width: calc(50% - 10px);  ëª¨ë°”ì¼ì—ì„œëŠ” 2ê°œì”© í‘œì‹œ */
        }
    }
    .main-pic {
        width: 100%; /* ì „ì²´ í­ì„ ì°¨ì§€ */
        /*aspect-ratio: 7 / 5;  7:5 ë¹„ìœ¨ */
        object-fit: cover; /* ë¹„ìœ¨ ìœ ì§€í•˜ë©° ì´ë¯¸ì§€ ì˜ë¦¼ ë°©ì§€ */
    }
    
    .title {
        display: inline-block; /* ë‚´ìš©ì„ ê°ì‹¸ëŠ” ë§Œí¼ë§Œ ë„ˆë¹„ ì„¤ì • */
        background-color: white; /* í°ìƒ‰ ë°°ê²½ */
        color: black; /* ê²€ì •ìƒ‰ ê¸€ì */
        text-align: center; /* ì¤‘ì•™ ì •ë ¬ */
        max-width: 100%; /* ìµœëŒ€ ë„ˆë¹„ ì„¤ì • */
        white-space: nowrap; /* ì¤„ ë°”ê¿ˆ ë°©ì§€ */
        overflow: hidden; /* ë„˜ì¹˜ëŠ” í…ìŠ¤íŠ¸ ìˆ¨ê¸°ê¸° */
        text-overflow: ellipsis; /* ... í‘œì‹œ */
        text-align: center; /* ì¤‘ì•™ ì •ë ¬ */
    }

    .score-reason {
        background-color: white; /* í°ìƒ‰ ë°°ê²½ */
        color: black; /* ê²€ì •ìƒ‰ ê¸€ì */
        padding: 5px;
        overflow: hidden; /* ë‚´ìš©ì´ ë„˜ì¹  ê²½ìš° ìˆ¨ê¹€ */
        text-overflow: ellipsis; /* ... í‘œì‹œ */
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2; /* 2ì¤„ë¡œ ì œí•œ */
    }
    
    .score {
        font-size: 1.6vw; /* í™”ë©´ ë„ˆë¹„ì˜ 5% í¬ê¸°ë¡œ ì„¤ì • */
        text-align: center; /* ì¤‘ì•™ ì •ë ¬ */
    }
    /* í•˜ì´í¼ë§í¬ì˜ ë°‘ì¤„ ì œê±° */
    .article-item a {
        text-decoration: none; /* ê¸°ë³¸ ë°‘ì¤„ ì œê±° */
        color: inherit; /* ë¶€ëª¨ì˜ ê¸€ì ìƒ‰ìƒ ìƒì† */
    }


</style>
{{>layouts/footer}}