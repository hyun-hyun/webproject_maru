{{>layouts/header}}
<div class="container">
<br>
<h2>ë§ˆì´í˜ì´ì§€</h2>
<br><br>

<div class="page-content">
    <!-- í‚¤ì›Œë“œ ë¶„ì„ ì˜ì—­ -->
    <div class="keyword-analysis">
    <h4>ğŸ”ë¦¬ë·°ì‹œ ì„ íƒí•œ í‚¤ì›Œë“œ ë¶„ì„</h4><br>
    <!--í‚¤ì›Œë“œë¶„ì„(ì›Œë“œí´ë¼ìš°ë“œ)-->
    <div id="container"></div>
    </div>
    <!-- íšŒì›ì •ë³´ ì˜ì—­ -->
    <div class="user-info">
      <h4>íšŒì›ì •ë³´</h4><br>
      <strong>{{nickname}}</strong>ë‹˜<br>
      {{email}}<br>
      <strong>ì„±ë³„: </strong>{{genderD}}<br>
      <strong>ë¦¬ë·° ìˆ˜:</strong> {{c_review}}ê°œ<br><br>
      <a href="/user/mypage/edit" class="btn btn-sm btn-primary">íšŒì›ì •ë³´ ìˆ˜ì •</a>
    </div>
</div>
<hr>
<div class="recent-loves">
    <h4>ğŸ”–ìµœê·¼ ì°œí•œ ì‘í’ˆ  <a href="/user/mypage/mylove" class="btn btn-sm btn-info">ì „ì²´ë³´ê¸°</a></h4>
    <div class="article-list" id="article-love-list">
        <!-- Fetchëœ ë°ì´í„° -->
    </div>
    <div id="loading" class="loading-container" style="display: none;">
        <div class="spinner"></div>
        <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
</div>
<br>
<hr>
<div class="recent-reviews">
    <h4>ğŸ“‘ìµœê·¼ ë¦¬ë·°í•œ ì‘í’ˆ  <a href="/user/mypage/myreview" class="btn btn-sm btn-info">ì „ì²´ ë¦¬ë·°ë³´ê¸°</a></h4>
    <div class="article-list" id="article-list">
        <!-- Fetchëœ ë°ì´í„° -->
    </div>
    <div id="loading" class="loading-container" style="display: none;">
        <div class="spinner"></div>
        <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
</div>
<hr>
<h4>ğŸ–¼ï¸ì¶”ì²œ ì‘í’ˆ</h4>
<div id="recommendations"></div>

  

<script>
    const memberId = {{member_id}}; 

    // ì›Œë“œí´ë¼ìš°ë“œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    fetch(`/api/mypage/wordcloud/${memberId}`)
        .then(response => response.json())
        .then(wordCounts => {
            const wordCloudData = wordCounts.map(tag => ({ x: tag.tagName, value: tag.count }));
            
            anychart.onDocumentReady(function() {
                var chart = anychart.tagCloud(wordCloudData);
                chart.title("ë‚˜ì˜ í‚¤ì›Œë“œ ë¶„ì„");
                chart.angles([0, 45, 90, -45]);
                //chart.textDirection("vertical");
                chart.container("container");
                chart.draw();
            });
        });

    //ì°œí•œì‘í’ˆ
    fetch(`/api/mypage/myloveOnly/${memberId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
            return response.json();
        })
        .then(data => {
            const articleList = document.getElementById('article-love-list');

            // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì´ ë¶€ë¶„ì—ì„œ ë°”ë¡œ ì¢…ë£Œ
            if (data.length === 0) {
                articleList.innerHTML = "<p>ì°œí•œ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>";
                return;
            }

            data.forEach(article => {
                // ìƒˆë¡œìš´ div ìƒì„±
                const articleItem = document.createElement('div');
                articleItem.className = 'article-love-item';

                // HTML êµ¬ì„±
                articleItem.innerHTML = `
                    <a href="/articles/anime/${article.articleId}" class="a">
                        <img src="/images/pic/anime/${article.main_pic}" alt="ë©”ì¸ì‚¬ì§„" class="main-pic">
                        <div class="title"><b>[${article.genre}]${article.title}</b></div>
                        <div class="love-story">${article.story}</div>
                    </a>
                `;

                // article-itemì„ article-listì— ì¶”ê°€
                articleList.appendChild(articleItem);
            });

        })
        .catch(error => {
            console.error('Error fetching the data:', error);
        });
    

    //ìµœê·¼ ë¦¬ë·°í•œ ì‘í’ˆ
    fetch(`/api/mypage/myreviewOnly/${memberId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
            return response.json();
        })
        .then(data => {
            const articleList = document.getElementById('article-list');
            // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì´ ë¶€ë¶„ì—ì„œ ë°”ë¡œ ì¢…ë£Œ
            if (data.length === 0) {
                articleList.innerHTML = "<p>ë¦¬ë·°í•œ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>";
                return;
            }

            data.forEach(articleReview => {
                // ìƒˆë¡œìš´ div ìƒì„±
                const articleItem = document.createElement('div');
                articleItem.className = 'article-item';
                articleItem.setAttribute('data-score', articleReview.score);

                // HTML êµ¬ì„±
                articleItem.innerHTML = `
                    <a href="/articles/anime/${articleReview.articleId}" class="a">
                        <div class="score"></div> <!-- ë³„ì„ í‘œì‹œí•  ë¶€ë¶„ -->
                        <img src="/images/pic/anime/${articleReview.main_pic}" alt="ë©”ì¸ì‚¬ì§„" class="main-pic">
                        <div class="title"><b>[${articleReview.genre}]${articleReview.title}</b></div>
                        <div class="score-reason">${articleReview.score_reason}</div>
                    </a>
                `;

                // article-itemì„ article-listì— ì¶”ê°€
                articleList.appendChild(articleItem);
            });

            // ë³„ í‘œì‹œ í•¨ìˆ˜ í˜¸ì¶œ
            displayStars();
            // ì°½ í¬ê¸° ë³€ê²½ ì‹œ ë³„ í¬ê¸° ì¬ì¡°ì •
            window.addEventListener('resize', displayStars);
        })
        .catch(error => {
            console.error('Error fetching the data:', error);
        });
    


    function displayStars() {
        const articles = document.querySelectorAll('.article-item');

        articles.forEach(article => {
            const score = parseInt(article.getAttribute('data-score')); // data-scoreì—ì„œ ì ìˆ˜ ê°€ì ¸ì˜¤ê¸°
            const starsContainer = article.querySelector('.score'); // ë³„ì„ í‘œì‹œí•  ìš”ì†Œ ì„ íƒ
            const imgElement = article.querySelector('.main-pic'); // í•´ë‹¹ ì•„í‹°í´ì˜ main-pic ì„ íƒ
    
            starsContainer.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì‚­ì œ
    
            if (imgElement) {
                const imgWidth = imgElement.width;  // ì´ë¯¸ì§€ì˜ ì‹¤ì œ ë„ˆë¹„ (150pxë¡œ ì„¤ì •)
                const starSize = imgWidth * 0.75 / 5; // ë³„ì˜ í¬ê¸°ë¥¼ ì´ë¯¸ì§€ì˜ 0.75ë°° í¬ê¸°ì—ì„œ 5ë“±ë¶„
    
                // ë³„ì„ í‘œì‹œ
                for (let i = 1; i <= 5; i++) {
                    const star = document.createElement('span');
                    star.className = 'star';
    
                    if (i <= score) {
                        star.textContent = 'â­'; // ì±„ì›Œì§„ ë³„
                    } else {
                        star.textContent = 'â˜†'; // ë¹ˆ ë³„
                    }
    
                    // ë³„ í¬ê¸° ì ìš©
                    star.style.fontSize = `${starSize}px`; // ë™ì ìœ¼ë¡œ ë³„ í¬ê¸° ì„¤ì •
                    starsContainer.appendChild(star);
                }
            }
        });
    }

    // ì¶”ì²œ ê²Œì‹œê¸€ ê°€ì ¸ì˜¤ê¸°
    let currentPage = 0; // í˜„ì¬ í˜ì´ì§€ (0ë¶€í„° ì‹œì‘)
    let loading = false; // ë°ì´í„°ë¥¼ ë¡œë”© ì¤‘ì¸ì§€ ì—¬ë¶€
    let hasMoreData = true; // ë” ì´ìƒ ë°ì´í„°ê°€ ìˆëŠ”ì§€ ì²´í¬

    // ì¶”ì²œ ê²Œì‹œê¸€ì„ ë¡œë“œí•˜ëŠ” í•¨ìˆ˜
    function loadRecommendedArticles(page) {
        if (loading || !hasMoreData){
            //console.log('í˜„ì¬ ë¡œë”© ì¤‘ì´ê±°ë‚˜ ë” ì´ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return; // ì´ë¯¸ ë°ì´í„°ë¥¼ ë¡œë”© ì¤‘ì´ê±°ë‚˜ ë” ì´ìƒ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ìš”ì²­ì„ í•˜ì§€ ì•ŠìŒ
        }
        loading = true; // ë¡œë”© ì‹œì‘
        //console.log(`í˜ì´ì§€ ${page} ë¡œë”© ì¤‘...`);
        document.getElementById('loading').style.display = 'block'; // ë¡œë”© ì¸ë””ì¼€ì´í„° í‘œì‹œ

        // ì¶”ì²œ ê²Œì‹œê¸€ API í˜¸ì¶œ
        fetch(`/api/mypage/recommended-articles/${memberId}?page=${page}`)
            .then(response => response.json())
            .then(articles => {
                const recommendationsContainer = document.getElementById("recommendations");
                if (articles.length === 0) {
                    //console.log('ë” ì´ìƒ ë¶ˆëŸ¬ì˜¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    hasMoreData = false;  // ë” ì´ìƒ ë¶ˆëŸ¬ì˜¬ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ hasMoreDataë¥¼ falseë¡œ ì„¤ì •
                    document.getElementById('loading').style.display = 'none'; // ë¡œë”© ìˆ¨ê¹€
                    return;
                }

                // ê° ê²Œì‹œê¸€ì„ HTMLë¡œ ë³€í™˜í•˜ì—¬ ì¶”ì²œ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
                articles.forEach(article => {
                    const articleDiv = document.createElement("div");
                    articleDiv.className = "article";

                    // usedTags ë°°ì—´ì„ <span> íƒœê·¸ë¡œ ë³€í™˜
                    let tagsHtml = '';
                    if (article.usedTags && Array.isArray(article.usedTags)) {
                        article.usedTags.forEach(tag => {
                            tagsHtml += `<span class="btn btn-outline-info m-1 tag">${tag}</span>`;
                        });
                    }

                    articleDiv.innerHTML = `
                        <div class="article-content">
                            <img src="/images/pic/anime/${article.main_pic}" width="150" alt="ì‘í’ˆí‘œì§€" class="article-image">
                            <div class="article-info">
                                <b class="title">[${article.genre}] ${article.title}</b>
                                <div class="tags">${tagsHtml}</div>
                                <div class="meta-info">
                                    ${article.broaddate} | ${article.author} | ${article.ani_company}
                                </div>
                                <span class="story">${article.story}</span>
                            </div>
                        </div>
                    `;
                    recommendationsContainer.appendChild(articleDiv);

                    // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                    articleDiv.querySelector('.article-content').addEventListener('click', () => {
                        window.location.href = `/articles/anime/${article.id}`;
                    });
                });

                // ë¡œë”© ìƒíƒœë¥¼ falseë¡œ ë³€ê²½
                loading = false;
                //console.log(`í˜ì´ì§€ ${page} ë°ì´í„° ë¡œë“œ ì™„ë£Œ`);
            })
            .catch(error => {
                console.error('ì¶”ì²œê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ë¬¸ì œê°€ ìƒê²¼ìŠµë‹ˆë‹¤: ', error);
                loading = false;
            })
            .finally(() => {
                document.getElementById('loading').style.display = 'none'; // ë¡œë”© ìˆ¨ê¹€
            });
    }

    // ë¬´í•œ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ì²˜ë¦¬
    window.addEventListener('scroll', function() {
        const scrollPosition = window.innerHeight + window.scrollY;
        const documentHeight = document.documentElement.scrollHeight;
    
        // í˜ì´ì§€ í•˜ë‹¨ì— ë„ë‹¬í•˜ë©´ ë‹¤ìŒ í˜ì´ì§€ ë¡œë“œ
        if (scrollPosition >= documentHeight - 500 && hasMoreData && !loading) {
            currentPage++;
            //console.log(`ìŠ¤í¬ë¡¤ë¡œ í˜ì´ì§€ ${currentPage} ë¡œë“œ`);
            loadRecommendedArticles(currentPage); // ìƒˆë¡œìš´ í˜ì´ì§€ì˜ ê²Œì‹œê¸€ì„ ë¡œë“œ
        }
    });
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì²« ë²ˆì§¸ í˜ì´ì§€ì˜ ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ê¸°
    document.addEventListener('DOMContentLoaded', function() {
        loadRecommendedArticles(currentPage); // ì²« ë²ˆì§¸ í˜ì´ì§€ ë¡œë“œ
    });
</script>

<style>
    /*íšŒì›ì •ë³´ìˆ˜ì •*/
    .page-content {
        display: flex;
        flex: 1;
    }
      
    .keyword-analysis {
        flex: 2;  /* í‚¤ì›Œë“œ ë¶„ì„ ì˜ì—­ì„ ë” ë„“ê²Œ */
    }
      
    .user-info {
        flex: 1;  /* íšŒì›ì •ë³´ ì˜ì—­ */
        padding: 20px;
        background: linear-gradient(145deg, #edf2fa, #e6ecf5);  /* ë¶€ë“œëŸ¬ìš´ ê·¸ë¼ë””ì–¸íŠ¸ ë°°ê²½ */
        border-radius: 10px;  /* ëª¨ì„œë¦¬ ë‘¥ê¸€ê¸° */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);  /* ë¶€ë“œëŸ¬ìš´ ê·¸ë¦¼ì */
        text-align: center;  /* ì¤‘ì•™ ì •ë ¬ */
        transition: transform 0.3s ease, box-shadow 0.3s ease;  /* ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ë¶€ë“œëŸ¬ìš´ íš¨ê³¼ */
    }
    
    /*ì°œí•œì‘í’ˆ*/
    /*ë‚´ê°€ ì“´ ë¦¬ë·°*/
   .recent-loves {
        margin-top: 20px;
    }
    .article-love-list {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start;  /* ì™¼ìª½ ì •ë ¬ */
    }
    .love-story {
        background-color: white; /* í°ìƒ‰ ë°°ê²½ */
        color: black; /* ê²€ì •ìƒ‰ ê¸€ì */
        padding: 5px;
        overflow: hidden; /* ë‚´ìš©ì´ ë„˜ì¹  ê²½ìš° ìˆ¨ê¹€ */
        text-overflow: ellipsis; /* ... í‘œì‹œ */
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2; /* 2ì¤„ë¡œ ì œí•œ */
    }
    .article-love-item {
        width: calc(20% - 10px); /* 5ê°œ ë‹¨ìœ„ë¡œ ê°€ë¡œ ë°°ì¹˜, ê°„ê²©ì„ ê³ ë ¤ */
        margin-bottom: 20px; /* ì„¸ë¡œ ê°„ê²© */
        position: relative; /* ìì‹ ìš”ì†Œì˜ ì ˆëŒ€ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì„¤ì • */
        padding: 15px;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        cursor: pointer;
    }
    

    /*ë‚´ê°€ ì“´ ë¦¬ë·°*/
   .recent-reviews {
        margin-top: 20px;
    }
    
    .article-list {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start;  /* ì™¼ìª½ ì •ë ¬ */
    }
    
    .article-item {
        width: calc(20% - 10px); /* 5ê°œ ë‹¨ìœ„ë¡œ ê°€ë¡œ ë°°ì¹˜, ê°„ê²©ì„ ê³ ë ¤ */
        margin-bottom: 20px; /* ì„¸ë¡œ ê°„ê²© */
        position: relative; /* ìì‹ ìš”ì†Œì˜ ì ˆëŒ€ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì„¤ì • */
        padding: 15px;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .article-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
    }

    .main-pic {
        width: 100%; /* ì „ì²´ í­ì„ ì°¨ì§€ */
        /*aspect-ratio: 7 / 5;  7:5 ë¹„ìœ¨ */
        object-fit: cover; /* ë¹„ìœ¨ ìœ ì§€í•˜ë©° ì´ë¯¸ì§€ ì˜ë¦¼ ë°©ì§€ */
    }
    
    .score-reason {
        background-color: white; /* í°ìƒ‰ ë°°ê²½ */
        color: black; /* ê²€ì •ìƒ‰ ê¸€ì */
        padding: 5px;
        overflow: hidden; /* ë‚´ìš©ì´ ë„˜ì¹  ê²½ìš° ìˆ¨ê¹€ */
        text-overflow: ellipsis; /* ... í‘œì‹œ */
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2; /* 2ì¤„ë¡œ ì œí•œ */
    }
    
    .score {
        text-align: center; /* ì¤‘ì•™ ì •ë ¬ */
    }

    

    /* ëª¨ë°”ì¼ í™”ë©´ì—ì„œ í•œ ì¤„ì— 3ê°œì”© ë³´ì´ë„ë¡ ì„¤ì • */
    @media (max-width: 768px) {
        .article-item {
            width: calc(33.33% - 10px); /* 3ê°œê°€ í•œ ì¤„ì— í‘œì‹œë˜ë„ë¡ ì„¤ì • (ì—¬ë°± ê³ ë ¤) */
            /*width: calc(50% - 10px);  ëª¨ë°”ì¼ì—ì„œëŠ” 2ê°œì”© í‘œì‹œ */
        }
    }


    /*ì¶”ì²œ ê²Œì‹œê¸€*/
    .recommendations {
        margin-top: 30px;
        display: flex;
        flex-direction: column;
        gap: 20px; /* ê° ì¶”ì²œ í•­ëª© ê°„ ê°„ê²© */
    }

    /* ë°˜ì‘í˜• ë””ìì¸ */
    @media (max-width: 768px) {
        .article-content {
            flex-direction: column; /* ëª¨ë°”ì¼ì—ì„œëŠ” ì„¸ë¡œë¡œ ìŒ“ì´ê²Œ */
            align-items: flex-start;
        }

        .article-image {
            margin-right: 0;
            margin-bottom: 15px;
        }
    }

</style>
{{>layouts/footer}}